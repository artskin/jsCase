<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <meta name="renderer" content="webkit">
  <title>Canvas 绘图</title>
  <meta name="description" content="首页描述"/>
  <meta name="keywords" content="首页关键词"/>
  <meta name="author" content="Web Layout:amu"/>
  <meta name="format-detection" content="telephone=no,date=no,address=no,email=no,url=no"/>
  <style>
    html{
      background: #e1e6e9;
    }
    body{
      /* display: flex;
      justify-content: center; */
      
      margin: 0;
      width: 100%;
      margin: 0 auto;
      max-width: 1000px;
      
      box-sizing: border-box;
    }
    .paper{background: white;padding: 10px;}
    h1{text-align: center;border-bottom: 2px gray solid;padding-bottom: 20px;}
  　#block{
      /* background-color: #ccc;
      border:3px solid #ccc; */
      width: 100%;
      height: 100%;
    }
    #canvas{position: absolute;background: rgba(0,0,0,.2);}
    #canvas2{border: 1px seagreen dashed;transform-origin: 0 0;
      width: 500px;height: 300px;max-width: 100%;
      box-sizing: border-box;
    }
    #canvas2:hover{cursor :url(assets/images/draw.ico),auto;}
  </style>
 </head>

<body>
<div class="paper">
  <h1>Canvas 绘图</h1>
  <h2>案例一：手绘自由线条（支持high DPI）</h2>
  <canvas id="canvas2" width="600" height="400"></canvas>
  <h2>案例二：显示多边形，且位置相对图片固定</h2>
  <div id="block">
    <canvas id="canvas"></canvas>
    <img id="video" width="60%" src="assets/images/map.png" alt="">
  </div>
</div>
</body>
<script>
  let videoDom=document.getElementById("video");
  let canvas=document.getElementById("canvas");
  let ctx=canvas.getContext("2d");
  let start = {x:351,y:385},end={x:503,y:520};

  videoDom.onload = ()=>{
    let scaleX = videoDom.width/originalVideo.width;
    let scaleY = videoDom.height/originalVideo.height;
    canvas.width = videoDom.width;
    canvas.height = videoDom.height;
    drawLine(start,end,scaleX,scaleY)
  }
    
  let originalVideo = {
    width:1407,
    height:1002
  }

  window.onresize = ()=>{
    let scaleX = videoDom.width/originalVideo.width;
    let scaleY = videoDom.height/originalVideo.height;
    canvas.width = videoDom.width;
    canvas.height = videoDom.height;
      
    drawLine(start,end,scaleX,scaleY)
  }

  function drawLine(start,end,scaleX,scaleY){
    ctx.clearRect(0,0,1000,1000)
    ctx.beginPath();
    ctx.scale(scaleX,scaleY)
    ctx.moveTo(start.x,start.y);
    
    ctx.lineTo(end.x,end.y);
    
    ctx.closePath();
    
    ctx.lineWidth = 2;
    ctx.setLineDash([5,15]);
    ctx.strokeStyle = "red"
    ctx.stroke();
  }
  
  function poly (num){
    let r = 100;
    let a = 2 * Math.PI / num;
    ctx.beginPath();
    ctx.moveTo(150+r,150);
    for(let i=0;i < num;i++){
      let x = 150 + r * Math.cos(a * i);
      let y = 150 + r * Math.sin(a * i);
      ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.stroke();
  }
  poly(8);
  let dpr = window.devicePixelRatio;
  let canvas2=document.getElementById("canvas2");
  
  //let ctx2=canvas2.getContext("2d");
  let ctx2=setupCanvas(canvas2);

  let drawX,drawY;
  let offsetX = 0,offsetY = -28;
  function drawInit(evt){
    drawX=evt.clientX-canvas2.offsetLeft-offsetX;
    drawY=evt.clientY-canvas2.offsetTop-offsetY;
    ctx2.beginPath();
    ctx2.lineCap="round";
    ctx2.shadowBlur=1.4;
    ctx2.shadowColor="#234";
    ctx2.moveTo(drawX,drawY);
  }
  canvas2.onmousedown=function(event){
    //ctx2.scale(1/dpr,1/dpr)
    drawInit(event)
    document.addEventListener('mousemove',drawFree)
  };
  function drawFree(evt){
    console.log(evt.clientX,canvas2.offsetLeft,evt)
    if(!evt.clientX){
      evt.clientX = evt.targetTouches[0].clientX
      evt.clientY = evt.targetTouches[0].clientY+offsetY
    }
    drawX = evt.clientX - canvas2.offsetLeft - offsetX;
    drawY = evt.clientY - canvas2.offsetTop - offsetY;
    ctx2.lineTo(drawX,drawY);
    ctx2.lineWidth = 6;
    ctx2.strokeStyle="#234";
    ctx2.stroke();
  }
  canvas2.addEventListener('touchstart',(e)=>{
    drawInit(e)
    canvas2.addEventListener('touchmove',drawFree)
  })
  //document.addEventListener('touchmove',drawFree)

  function setupCanvas(canvas) {
    // Get the device pixel ratio, falling back to 1.
    var dpr = window.devicePixelRatio || 1;
    // Get the size of the canvas in CSS pixels.
    var rect = canvas.getBoundingClientRect();
    //console.log(rect)
    // Give the canvas pixel dimensions of their CSS
    // size * the device pixel ratio.
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    var ctx = canvas.getContext('2d');
    // Scale all drawing operations by the dpr, so you
    // don't have to worry about the difference.
    ctx.scale(dpr, dpr);
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(10, 10);
    ctx.lineTo(10, 100);
    ctx.lineTo(100, 100);
    ctx.lineTo(100, 10);
    ctx.stroke();
    return ctx;
  }

  document.onmouseup=function(){
    ctx2.closePath();
    document.removeEventListener('mousemove',drawFree);
  };

</script>

</html>