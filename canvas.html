<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <meta name="renderer" content="webkit">
  <title>Canvas 绘图</title>
  <meta name="description" content="首页描述"/>
  <meta name="keywords" content="首页关键词"/>
  <meta name="author" content="Web Layout:amu"/>
  <meta name="format-detection" content="telephone=no,date=no,address=no,email=no,url=no"/>
  <link rel="stylesheet" href="./src/style/base.css">
  <style>
  　#block{
      width: 100%;
      height: 100%;
    }
    #canvas{position: absolute;background: rgba(0,0,0,.2);}
    #canvas2{
      border: 1px seagreen dashed;transform-origin: 0 0;
      width: 600px;height: 300px;max-width: 100%;
      box-sizing: border-box;
      margin-top: 10px;
    }
    #canvas2:hover{cursor :url(assets/images/draw.ico) 0 28,auto;}
    #save_href{display: none;}
    #outimg{z-index: 10;top:20%}
    #outimg img{max-width: 100%;border: 1px dashed #ccc;}
  </style>
 </head>

<body>
<div class="paper">
  <h1>Canvas 绘图</h1>
  <hr>
  <h2>案例一：手绘自由线条（支持high DPI）</h2>
  <button onclick="clearCanvas()">清空</button>
  <button onclick="saveCanvas()">生成图片</button> 
  <a download="mydraw.png" id="save_href">下载</a>
  <span id="touchSize"></span>
  <br>
  <canvas id="canvas2" width="600" height="400"></canvas>
  <dialog id="outimg">
    <img src="" alt="">
    <p>长按下载 <button onclick="closeDialog()">关闭</button></p>
  </dialog>
  <h2>案例二：显示多边形，且位置相对图片固定</h2>
  <div id="block">
    <canvas id="canvas"></canvas>
    <img id="video" width="60%" src="assets/images/map.png" alt="">
  </div>
  
</div>
</body>
<script>
  let videoDom=document.getElementById("video");
  let canvas=document.getElementById("canvas");
  let ctx=canvas.getContext("2d");
  let start = {x:351,y:385},end={x:503,y:520};

  videoDom.onload = ()=>{
    let scaleX = videoDom.width/originalVideo.width;
    let scaleY = videoDom.height/originalVideo.height;
    canvas.width = videoDom.width;
    canvas.height = videoDom.height;
    drawLine(start,end,scaleX,scaleY)
  }
    
  let originalVideo = {
    width:1407,
    height:1002
  }

  window.onresize = ()=>{
    let scaleX = videoDom.width/originalVideo.width;
    let scaleY = videoDom.height/originalVideo.height;
    canvas.width = videoDom.width;
    canvas.height = videoDom.height;
      
    drawLine(start,end,scaleX,scaleY)
  }

  function drawLine(start,end,scaleX,scaleY){
    ctx.clearRect(0,0,1000,1000)
    ctx.beginPath();
    ctx.scale(scaleX,scaleY)
    ctx.moveTo(start.x,start.y);
    
    ctx.lineTo(end.x,end.y);
    
    ctx.closePath();
    
    ctx.lineWidth = 2;
    ctx.setLineDash([5,15]);
    ctx.strokeStyle = "red"
    ctx.stroke();
  }
  
  function poly (num){
    let r = 100;
    let a = 2 * Math.PI / num;
    ctx.beginPath();
    ctx.moveTo(150+r,150);
    for(let i=0;i < num;i++){
      let x = 150 + r * Math.cos(a * i);
      let y = 150 + r * Math.sin(a * i);
      ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.stroke();
  }
  poly(8);
  let dpr = window.devicePixelRatio;
  let canvas2=document.getElementById("canvas2");
  
  //let ctx2=canvas2.getContext("2d");
  let ctx2=setupCanvas(canvas2);
  let touchSize = document.querySelector('#touchSize')

  let drawX,drawY;
  function drawInit(evt){
    drawX=evt.clientX-canvas2.offsetLeft;
    drawY=evt.clientY-canvas2.offsetTop;
    ctx2.beginPath();
    ctx2.lineCap="round";
    ctx2.shadowBlur=1.4;
    ctx2.shadowColor="#234";
    ctx2.moveTo(drawX,drawY);
  }
  canvas2.onmousedown=function(event){
    //ctx2.scale(1/dpr,1/dpr)
    drawInit(event)
    document.addEventListener('mousemove',drawFree)
  };
  function clearCanvas(){
    console.log(ctx2)
    ctx2.clearRect(0,0,ctx2.canvas.width,ctx2.canvas.height)
  }
  let outDialog = document.querySelector("#outimg")
  function saveCanvas(){
    ctx2.save()
    //console.log(ctx2,canvas2.toDataURL("image/png"))
    let image = new Image()
    image.src = canvas2.toDataURL("image/png")
    
    if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)){
      outDialog.open = true
      outDialog.querySelector('img').src=image.src
    }else{
      svaeHref = document.querySelector('#save_href')
      svaeHref.style.display = 'inline-block'
      svaeHref.href=image.src;
    }
  }
  function closeDialog(){
    outDialog.open = false
  }
  function drawFree(evt){
    evt.preventDefault();
    evt.stopPropagation();
    if(!evt.clientX){
      console.log(evt)
      touchSize.innerHTML = evt.targetTouches[0].radiusX+'-'+evt.targetTouches[0].force //force[0.1~1]
      evt.clientX = evt.targetTouches[0].clientX
      evt.clientY = evt.targetTouches[0].clientY
    }
    drawX = evt.clientX - canvas2.offsetLeft;
    drawY = evt.clientY - canvas2.offsetTop;
    ctx2.lineTo(drawX,drawY);
    ctx2.lineWidth = 6;
    ctx2.strokeStyle="#234";
    ctx2.stroke();
  }
  canvas2.addEventListener('touchstart',(e)=>{
    drawInit(e)
    canvas2.addEventListener('touchmove',drawFree)
  })
  //document.addEventListener('touchmove',drawFree)

  function setupCanvas(canvas) {
    // Get the device pixel ratio, falling back to 1.
    var dpr = window.devicePixelRatio || 1;
    // Get the size of the canvas in CSS pixels.
    var rect = canvas.getBoundingClientRect();
    //console.log(rect)
    // Give the canvas pixel dimensions of their CSS
    // size * the device pixel ratio.
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    var ctx = canvas.getContext('2d');
    // Scale all drawing operations by the dpr, so you
    // don't have to worry about the difference.
    ctx.scale(dpr, dpr);
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(10, 10);
    ctx.lineTo(10, 50);
    ctx.lineTo(50, 50);
    ctx.lineTo(50, 10);
    ctx.stroke();
    return ctx;
  }

  document.onmouseup=function(){
    ctx2.closePath();
    document.removeEventListener('mousemove',drawFree);
  };

</script>

</html>